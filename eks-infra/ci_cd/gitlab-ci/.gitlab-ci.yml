stages:
  - validate
  - plan
  - deploy

variables:
  TF_ROOT: terraform/environments/production
  AWS_DEFAULT_REGION: us-east-1

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

validate:
  stage: validate
  image: hashicorp/terraform:${TF_VERSION}
  script:
    - cd $TF_ROOT
    - terraform init
    - terraform validate
    - terraform fmt -check
  rules:
    - changes:
      - terraform/**/*

terraform-plan:
  stage: plan
  image: hashicorp/terraform:${TF_VERSION}
  script:
    - cd $TF_ROOT
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - $TF_ROOT/tfplan
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

terraform-apply:
  stage: deploy
  image: hashicorp/terraform:${TF_VERSION}
  script:
    - cd $TF_ROOT
    - terraform init
    - terraform apply -auto-approve tfplan
  environment:
    name: production
    action: start
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

helm-deploy:
  stage: deploy
  image: alpine/helm:3.14
  before_script:
    - apk add --no-cache curl bash
    - curl -L https://github.com/helmfile/helmfile/releases/latest/download/helmfile_linux_amd64 -o /usr/local/bin/helmfile && chmod +x /usr/local/bin/helmfile
  script:
    - CLUSTER_NAME=$(cd $TF_ROOT && terraform output -raw cluster_name)
    - aws eks update-kubeconfig --name $CLUSTER_NAME --region $AWS_DEFAULT_REGION
    - helmfile -f helm-releases/infrastructure/ apply
    - helmfile -f helm-releases/monitoring/ apply
    - helmfile -f helm-releases/applications/ apply
  environment:
    name: production
  rules:
    - changes:
      - helm-charts/**/*
      - helm-releases/**/*
